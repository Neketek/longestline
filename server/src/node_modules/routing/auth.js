const express = require('express');
const bodyParser = require('body-parser');
const multer = require('multer');
const router = express.Router();
const mongodb = require('model/mongo/db.js');
const passwordUtil = require('utils/password.js');
const jwt = require('utils/jwt.js');

const jsonBody = bodyParser.json();

router.post(

  '/login',
  mongodb.connect,
  jsonBody,

  async (req, res)=>{
    const users = await (await req.mongodb()).collection('users');
    const user = await users.findOne({email:req.body.email});
    if(!user){
      res.json({error:"No user"});
    }
    const {
      password:{
        hash,
        salt
      }
    } = user;
    if (passwordUtil.check({hash, salt, password:req.body.password})){
      res.json(await jwt.createUserAccessToken(user));
    }else{
      res.json({error:"Incorrect credentials"});
    }
    //
  }
)


router.post(

  '/signup',
  mongodb.connect,
  jsonBody,

  async (req, res)=>{

    const db = await req.mongodb();
    const users = await db.collection('users');

    let {
      email,
      password
    } = req.body;

    password = passwordUtil.hash({password});

    const _id = (await users.insertOne({email, password})).insertedId;
    const user = await users.findOne({_id});
    res.json(await jwt.createUserAccessToken(user));

});


module.exports = router;
