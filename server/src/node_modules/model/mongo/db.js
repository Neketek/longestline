const mongodb = require("mongodb");


const URL = "mongodb://mongodb:27017";
const DB_NAME = "longestline";
const OPTIONS = {
  poolSize:25,
  useNewUrlParser:true,
}


const middleware=client=>{
  return (req, res, next)=>{

    req.mongodb = async (dbname=DB_NAME)=>{
      req.mongodb.conn = await client.connect();
      return req.mongodb.conn.db(dbname);
    };

    try{
      next();
    }finally{
      if(req.mongodb.conn){
        req.mongodb.conn.close();
      }
    }

  }
}

module.exports = middleware(new mongodb.MongoClient(URL, OPTIONS));
